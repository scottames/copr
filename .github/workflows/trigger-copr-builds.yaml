---
name: trigger package copr builds
on:
  push:
    branches: [main]
    paths:
      - "*/*.spec"
  workflow_dispatch:
    inputs:
      # checkov:skip=CKV_GHA_7:arg passed to env
      spec_file:
        description: "Spec file to build (format: project/package.spec)"
        required: false
        type: string
permissions:
  contents: read # required for actions/checkout
env:
  COPR_OWNER: scottames
jobs:
  matrix_from_changed_specs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix_from_changed_spec_files.outputs.matrix }}
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
      - name: Get changed spec files
        id: changed_specs
        # yamllint disable rule:line-length
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46.0.5
        with:
          files: |
            */*.spec
      - name: Create package matrix
        id: matrix_from_changed_spec_files
        # yamllint disable rule:line-length
        run: |
          set -euo pipefail
          MATRIX_JSON=""
          # used to ensure unique "project:package" strings, newline-separated
          SEEN_COMBINATIONS=""

          # Check if manual spec file was provided via workflow_dispatch
          MANUAL_SPEC_FILE="${{ github.event.inputs.spec_file }}"

          if [ -n "${MANUAL_SPEC_FILE}" ]; then
            echo "::notice::Using manually specified spec file: ${MANUAL_SPEC_FILE}"
            # Use the manually specified spec file instead of changed files
            SPEC_FILES="${MANUAL_SPEC_FILE}"
          else
            # Use the detected changed files
            SPEC_FILES="${{ steps.changed_specs.outputs.all_changed_files }}"
          fi

          for COPR_SPEC_FILE in ${SPEC_FILES}; do
            # Skip if spec_file is empty (e.g. if there were extra spaces in the input)
            if [ -z "$COPR_SPEC_FILE" ]; then
              continue
            fi

            COPR_PROJECT="$(dirname "$COPR_SPEC_FILE")"
            # Remove potential ./ prefix if present
            #   (e.g. if find results included it)
            COPR_PROJECT="${COPR_PROJECT#./}"

            # Extract package name from the 'Name:' field in the spec file
            # Using grep -Po for Perl-compatible regex to get only the matched
            # group. Assumes 'Name:' is at the beginning of a line.
            COPR_PACKAGE_NAME="$(grep -Po '^Name:\s*\K[^[:space:]]+' "$COPR_SPEC_FILE")"

            if [ -z "${COPR_PACKAGE_NAME}" ]; then
              echo "::warning file=$COPR_SPEC_FILE::Could not extract package name from $COPR_SPEC_FILE"
              continue # Skip this file if package name couldn't be extracted
            fi

            COMBO_KEY="${COPR_PROJECT}:${COPR_PACKAGE_NAME}"
            CURRENT_JSON="{\"project\":\"${COPR_PROJECT}\",\"package\":\"${COPR_PACKAGE_NAME}\"}"

            # Check if this combination has been seen before
            # grep -qxF: q (quiet), x (exact line match), F (fixed string)
            if ! echo "${SEEN_COMBINATIONS}" | grep -qxF "${COMBO_KEY}"; then
              # If new, add to SEEN_COMBINATIONS and append to MATRIX_JSON
              # Add with a newline for exact matching
              SEEN_COMBINATIONS="${SEEN_COMBINATIONS}${COMBO_KEY}"$'\n'
              if [ -z "${MATRIX_JSON}" ]; then
                MATRIX_JSON="${CURRENT_JSON}"
              else
                MATRIX_JSON="${MATRIX_JSON},${CURRENT_JSON}"
              fi
            fi
          done

          echo "::group::Generated build matrix"
          echo "Final MATRIX_JSON string: ${MATRIX_JSON}"
          echo "::endgroup::"

          # If MATRIX_JSON is empty, output an empty include list
          # otherwise, output the list of JSON objects
          if [ -z "${MATRIX_JSON}" ]; then
            # shellcheck disable=SC2086
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            # shellcheck disable=SC2086
            echo "matrix={\"include\":[$MATRIX_JSON]}" >> $GITHUB_OUTPUT
          fi
        # yamllint enable rule:line-length
  trigger-package-build:
    needs: matrix_from_changed_specs
    if: |
      needs.matrix_from_changed_specs.outputs.matrix != '{"include":[]}'
      || github.event.inputs.spec_file != ''
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.matrix_from_changed_specs.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Install copr-cli
        run: |
          set -euo pipefail
          echo "::group::Installing system dependencies"
          sudo apt-get update
          sudo apt-get install -y python3-dev libkrb5-dev
          echo "::endgroup::"

          echo "::group::Installing COPR CLI dependencies"
          python3 -m pip install copr-cli requests_gssapi
          echo "::endgroup::"
      - name: Configure copr-cli authentication
        env:
          COPR_CONFIG: ${{ secrets.COPR_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config
          touch ~/.config/copr
          chmod 600 ~/.config/copr
          echo "${COPR_CONFIG}" > ~/.config/copr
      - name: Build ${{ matrix.package }}
        # yamllint disable rule:line-length
        run: |
          set -euo pipefail
          echo "::notice file=${{ matrix.project }}/${{ matrix.package }}.spec::Building package ${{ matrix.package }} in project ${{ matrix.project }}"
          copr-cli build-package \
            --name ${{ matrix.package }} \
            "${COPR_OWNER}/${{ matrix.project }}"
        # yamllint enable rule:line-length
      - name: Cleanup configuration
        if: always()
        run: rm -f ~/.config/copr
