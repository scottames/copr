---
name: build changed spec files
on:
  pull_request:
    paths:
      - "*/*.spec"
permissions:
  contents: read
  pull-requests: read
concurrency:
  # yamllint disable-line rule:line-length
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: changed spec files
        id: changed-files
        # https://www.stepsecurity.io/blog/harden-runner-detection-tj-actions-changed-files-action-is-compromised
        # yamllint disable-line rule:line-length
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files: |
            **/*.spec
      - name: Set matrix output
        id: set-matrix
        # yamllint disable rule:line-length
        run: |
          files="${{ steps.changed-files.outputs.all_changed_files }}"
          json_include="[]"
          if [ -n "$files" ]; then
            json_include="["
            for file in $files; do
              os="ubuntu-24.04"
              if [[ "$file" == *aarch64.spec ]] || [[ "$file" == *arm.spec ]]; then
                os="ubuntu-24.04-arm"
              fi
              json_include+=$(printf '{"spec-file":"%s","os":"%s"},' "$file" "$os")
            done
            json_include="${json_include%,}]"
          fi
          echo "matrix={\"include\":$json_include}" >> "$GITHUB_OUTPUT"
        # yamllint enable rule:line-length
  build-spec:
    name: build ${{ matrix.spec-file }} (F${{ matrix.fedora-version }})
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        fedora-version: ["42", "43"]
        include: ${{ fromJson(needs.detect-changes.outputs.matrix).include }}
      fail-fast: false
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: dagger build ${{ matrix.spec-file }} (F${{ matrix.fedora-version }})
        # yamllint disable-line rule:line-length
        uses: dagger/dagger-for-github@b81317a976cb7f7125469707321849737cd1b3bc # v7
        with:
          version: "latest"
          verb: call
          # yamllint disable-line rule:line-length
          args: build-spec-file --spec-file "${{ matrix.spec-file }}" --fedora-version "${{ matrix.fedora-version }}"
